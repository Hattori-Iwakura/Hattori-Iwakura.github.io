---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";

const posts = (await getCollection("blog")).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Get all unique categories
const categories = [
	"All",
	...new Set(posts.map((post) => post.data.category).filter(Boolean)),
];

// Get selected category from URL params
const url = new URL(Astro.request.url);
const selectedCategory = url.searchParams.get("category") || "All";

// Filter posts by category
const filteredPosts =
	selectedCategory === "All"
		? posts
		: posts.filter((post) => post.data.category === selectedCategory);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			main {
				width: 960px;
			}
			.filter-section {
				margin-bottom: 3rem;
				text-align: center;
			}
			.filter-section h2 {
				font-size: 2rem;
				margin-bottom: 1.5rem;
				background: linear-gradient(to right, #8b5cf6, #3b82f6);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}
			.category-filters {
				display: flex;
				gap: 1rem;
				justify-content: center;
				flex-wrap: wrap;
			}
			.category-btn {
				padding: 0.6rem 1.2rem;
				background: rgba(26, 26, 26, 0.7);
				border: 1px solid rgba(139, 92, 246, 0.3);
				border-radius: 8px;
				color: var(--text-secondary, #9ca3af);
				text-decoration: none;
				transition: all 0.3s ease;
				cursor: pointer;
				font-size: 0.95rem;
			}
			.category-btn:hover {
				background: rgba(139, 92, 246, 0.2);
				border-color: #8b5cf6;
				color: #fff;
				transform: translateY(-2px);
			}
			.category-btn.active {
				background: linear-gradient(135deg, #8b5cf6, #3b82f6);
				border-color: transparent;
				color: #fff;
				box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
			}
			ul {
				display: flex;
				flex-wrap: wrap;
				gap: 2rem;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			ul li {
				width: calc(50% - 1rem);
				position: relative;
			}
			ul li * {
				text-decoration: none;
				transition: 0.2s ease;
			}
			ul li:first-child {
				width: 100%;
				margin-bottom: 1rem;
				text-align: center;
			}
			ul li:first-child img {
				width: 100%;
			}
			ul li:first-child .title {
				font-size: 2.369rem;
			}
			ul li img {
				margin-bottom: 0.5rem;
				border-radius: 12px;
			}
			ul li a {
				display: block;
			}
			.title {
				margin: 0;
				color: rgb(var(--black));
				line-height: 1;
			}
			.date {
				margin: 0;
				color: rgb(var(--gray));
			}
			.category-badge {
				display: inline-block;
				padding: 0.3rem 0.8rem;
				margin-top: 0.5rem;
				background: rgba(139, 92, 246, 0.2);
				border: 1px solid rgba(139, 92, 246, 0.4);
				border-radius: 6px;
				color: #a78bfa;
				font-size: 0.85rem;
				font-weight: 500;
			}
			ul li a:hover h4,
			ul li a:hover .date {
				color: rgb(var(--accent));
			}
			ul a:hover img {
				box-shadow: var(--box-shadow);
			}
			@media (max-width: 720px) {
				ul {
					gap: 0.5em;
				}
				ul li {
					width: 100%;
					text-align: center;
				}
				ul li:first-child {
					margin-bottom: 0;
				}
				ul li:first-child .title {
					font-size: 1.563em;
				}
				.category-filters {
					gap: 0.5rem;
				}
				.category-btn {
					padding: 0.5rem 1rem;
					font-size: 0.85rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<section class="filter-section">
				<h2>Blog Categories</h2>
				<div class="category-filters">
					{
						categories.map((category) => (
							<a
								href={
									category === "All"
										? "/blog"
										: `/blog?category=${encodeURIComponent(category || "")}`
								}
								class={`category-btn ${selectedCategory === category ? "active" : ""}`}
							>
								{category}
							</a>
						))
					}
				</div>
			</section>
			<section>
				<ul>
					{
						filteredPosts.map((post) => (
							<li>
								<a href={`/blog/${post.id}/`}>
									{post.data.heroImage && (
										<Image
											width={720}
											height={360}
											src={post.data.heroImage}
											alt=""
										/>
									)}
									<h4 class="title">{post.data.title}</h4>
									<p class="date">
										<FormattedDate
											date={post.data.pubDate}
										/>
									</p>
									{post.data.category && (
										<span class="category-badge">
											{post.data.category}
										</span>
									)}
								</a>
							</li>
						))
					}
				</ul>
			</section>
		</main>
		<Footer />

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const categoryButtons =
					document.querySelectorAll(".category-btn");
				const postItems = document.querySelectorAll("ul li");

				categoryButtons.forEach((button) => {
					button.addEventListener("click", (e) => {
						e.preventDefault();

						// Update active state
						categoryButtons.forEach((btn) =>
							btn.classList.remove("active"),
						);
						button.classList.add("active");

						// Get selected category
						const selectedCategory = button.textContent.trim();

						// Filter posts
						postItems.forEach((item) => {
							const categoryBadge =
								item.querySelector(".category-badge");
							const postCategory = categoryBadge
								? categoryBadge.textContent.trim()
								: "";

							if (
								selectedCategory === "All" ||
								postCategory === selectedCategory
							) {
								item.style.display = "block";
							} else {
								item.style.display = "none";
							}
						});

						// Update URL without reload
						const url =
							selectedCategory === "All"
								? "/blog"
								: `/blog?category=${encodeURIComponent(selectedCategory)}`;
						window.history.pushState({}, "", url);
					});
				});

				// Handle initial load from URL params
				const urlParams = new URLSearchParams(window.location.search);
				const categoryFromUrl = urlParams.get("category");

				if (categoryFromUrl) {
					const targetButton = Array.from(categoryButtons).find(
						(btn) => btn.textContent.trim() === categoryFromUrl,
					);
					if (targetButton) {
						targetButton.click();
					}
				}
			});
		</script>
	</body>
</html>
